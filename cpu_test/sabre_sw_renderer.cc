#include <intrin.h>
#include <stdio.h>
#include <math.h>
#include "sabre.h"
#include "sabre_math.h"
#include "sabre_svo.h"

#define SVO_NODE_OCCUPIED_MASK  0x0000FF00U
#define SVO_NODE_LEAF_MASK      0x000000FFU
// TODO(Liam): Need to fix this up to support
// far pointers!
#define SVO_NODE_CHILD_PTR_MASK 0x7FFF0000U
#define SVO_FAR_PTR_BIT_MASK    0x80000000U

#define SVO_FAR_PTRS_PER_BLOCK  64
#define SVO_ENTRIES_PER_BLOCK   16

#define MAX_STEPS 16
#define SCREEN_DIM 512

#define ASSERT(Expr) if (! (Expr)) { return vec3(1); }

#define in
#define out
#define inout

typedef unsigned int uint;

static vec3 OutBuffer[512][512];

struct vec2
{
    float X;
    float Y;
};

struct ray
{
    vec3 Origin;
    vec3 Dir;
    vec3 InvDir;
};

struct stack_frame
{
    uint Oct;
    uint Depth;
    uint Scale;
    uint Node;
    vec3 Centre;
};

struct ray_intersection
{
    float tMin;
    float tMax;
    vec3  tMaxV;
    vec3  tMinV;
};

static uint MaxDepthUniform = 4;
static uint BlockCountUniform = 1;
static uint ScaleExponentUniform = 5;

static vec3 ViewPosUniform = vec3(-5, -5, -512);
static mat3 ViewMatrixUniform;


struct svo_input
{
    uint Nodes[];
};

struct far_ptr_input
{
    far_ptr FarPtrs[];
};

static far_ptr_input SvoFarPtrBuffer = {
    // {{{ 
    {
        { 1,0 },
        { 1,0 },
        { 1,0 },
        { 1,0 },
        { 1,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
        { 0,0 },
    } // }}}
};

static svo_input SvoInputBuffer = {
    { // {{{

        130816,
        655104,
        130816,
        655104,
        130816,
        655104,
        130816,
        655104,
        130816,
        622592,
        719872,
        2147547648,
        458497,
        978433,
        327425,
        851713,
        327425,
        850945,
        147457,
        261889,
        783617,
        130817,
        646401,
        1048320,
        524032,
        1047040,
        392960,
        860160,
        979712,
        327424,
        851712,
        310016,
        720640,
        196352,
        718080,
        2147545856,
        397312,
        524032,
        1048320,
        524032,
        1013504,
        388608,
        786176,
        261888,
        786176,
        198656,
        315136,
        700160,
        2147548928,
        589568,
        2147540224,
        458496,
        982784,
        446208,
        787456,
        917248,
        352000,
        786176,
        261888,
        768768,
        130816,
        634624,
        1048320,
        459264,
        540416,
        982784,
        458496,
        982784,
        423680,
        851712,
        286464,
        671488,
        2147483904,
        59624 ,
        49344 ,
        61680 ,
        49344 ,
        52428 ,
        65535 ,
        65535 ,
        41120 ,
        61680 ,
        41120 ,
        65535 ,
        43690 ,
        65535 ,
        65278 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        34952 ,
        34952 ,
        65535 ,
        52428 ,
        43690 ,
        65535 ,
        65278 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65278 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        61680 ,
        49344 ,
        52428 ,
        49344 ,
        65535 ,
        65535 ,
        54484 ,
        65535 ,
        65021 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        20560 ,
        61680 ,
        65535 ,
        20560 ,
        65535 ,
        21845 ,
        65535 ,
        65021 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        17476 ,
        65535 ,
        17476 ,
        52428 ,
        65535 ,
        21845 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65021 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        61680 ,
        41120 ,
        43690 ,
        65535 ,
        41120 ,
        65535 ,
        65535 ,
        65535 ,
        64507 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        45746 ,
        12336 ,
        61680 ,
        65535 ,
        65535 ,
        12336 ,
        13107 ,
        65535 ,
        65535 ,
        64507 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        8738,
        65535,
        8738,
        43690,
        65535,
        13107,
        65535,
        65535,
        64507,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        63479,
        65535,
        65535,
        65535,
        65535,
        61680,
        20560,
        65535,
        21845,
        65535,
        20560,
        61680,
        12336,
        65535,
        65535,
        13107,
        12336,
        29041,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        63479,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        63479,
        65535,
        65535,
        65535,
        65535,
        65535,
        4369,
        4369,
        65535,
        21845,
        13107,
        52428,
        43690,
        65535,
        34952,
        34952,
        65535,
        65535,
        65535,
        65535,
        65535,
        61423,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        61423,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        36494,
        3084,
        52428,
        65535,
        65535,
        3084,
        3855,
        2570,
        65535,
        43690,
        65535,
        2570,
        3855,
        65535,
        65535,
        65535,
        65535,
        61423,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        57311,
        65535,
        65535,
        52428,
        65535,
        21845,
        17476,
        65535,
        17476,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        57311,
        65535,
        65535,
        52428,
        3084,
        65535,
        65535,
        3855,
        3084,
        19789,
        65535,
        65535,
        65535,
        65535,
        65535,
        57311,
        65535,
        65535,
        65535,
        1285,
        65535,
        21845,
        1285,
        3855,
        65535,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        49087 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        65535 ,
        43690 ,
        65535 ,
        13107 ,
        8738,
        65535,
        8738,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        49087,
        65535,
        43690,
        65535,
        2570,
        65535,
        3855,
        2570,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        49087,
        65535,
        11051,
        65535,
        65535,
        771,
        13107,
        771,
        3855,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        32639,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        32639,
        65535,
        21845,
        13107,
        65535,
        4369,
        4369,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        65535,
        32639,
        65535,
        21845,
        65535,
        1286,
        3856,
        1286,
        65535,
        65535,
        13107,
        771,
        3855,
        771,
        5911,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0 ,
        0 ,
        0 ,
        0 ,
        0 ,
        0 ,
        0,
    } // }}}
};

static uint PrevOct;


uint BitCount(uint X)
{
    return __popcnt(X);
}


uvec3 FindMSB(uvec3 A)
{
    uvec3 Result;

    unsigned long MSB;
    _BitScanReverse(&MSB, A.X);
    Result.X = (u32)MSB;

     _BitScanReverse(&MSB, A.Y);
    Result.Y = (u32)MSB;

     _BitScanReverse(&MSB, A.Z);
    Result.Z = (u32)MSB;

    return Result;
}

uint GetNodeChild(in uint ParentNode, in uint Oct, inout int& BlkIndex)
{
    if (! bool(ParentNode & SVO_FAR_PTR_BIT_MASK))
    {
        uint ChildPtr = (ParentNode & SVO_NODE_CHILD_PTR_MASK) >> 16;
        uint OccBits = (ParentNode & SVO_NODE_OCCUPIED_MASK) >> 8; 
        uint LeafBits = (ParentNode & SVO_NODE_LEAF_MASK);
        uint OccupiedNonLeafOcts = OccBits & (~LeafBits);
        uint SetBitsBehindOctIdx = (1 << Oct) - 1;

        uint ChildOffset = BitCount(OccupiedNonLeafOcts & SetBitsBehindOctIdx); 

        // TODO(Liam): Broken?
        return SvoInputBuffer.Nodes[ChildPtr + ChildOffset];
    }
    else
    {
        // Perform far ptr lookup
        uint ParentBlk = BlkIndex;
        uint FarPtrIndex = (ParentNode & SVO_NODE_CHILD_PTR_MASK) >> 16;
        far_ptr FarPtr = SvoFarPtrBuffer.FarPtrs[ParentBlk*SVO_FAR_PTRS_PER_BLOCK + FarPtrIndex];
        BlkIndex += FarPtr.BlkOffset;

        uint ChildBlkStart = FarPtr.BlkOffset * SVO_ENTRIES_PER_BLOCK;

        uint OccBits = (ParentNode & SVO_NODE_OCCUPIED_MASK) >> 8; 
        uint LeafBits = (ParentNode & SVO_NODE_LEAF_MASK);
        uint OccupiedNonLeafOcts = OccBits & (~LeafBits);
        uint SetBitsBehindOctIdx = (1 << Oct) - 1;

        uint ChildOffset = BitCount(OccupiedNonLeafOcts & SetBitsBehindOctIdx); 

        return SvoInputBuffer.Nodes[BlkIndex + FarPtr.NodeOffset + ChildOffset];
    }
}

ray_intersection ComputeRayBoxIntersection(in ray R, in vec3 vMin, in vec3 vMax)
{
    vec3 t0 = (vMin - R.Origin) * R.InvDir;
    vec3 t1 = (vMax - R.Origin) * R.InvDir;

    vec3 tMin = Min(t0, t1);
    vec3 tMax = Max(t0, t1);

    float ttMin = MaxComponent(tMin);
    float ttMax = MinComponent(tMax);

    ray_intersection Result = { ttMin, ttMax, tMax, tMin };
    return Result;
}


bool IsAdvanceValid(in uint NewOct, in uint OldOct, in vec3 RayDir)
{
    ivec3 Sgn = ivec3(Sign(RayDir));
    uvec3 OctBits = uvec3(1, 2, 4);
    
    ivec3 NewOctBits = ivec3(bvec3(uvec3(NewOct) & OctBits));
    ivec3 OldOctBits = ivec3(bvec3(uvec3(OldOct) & OctBits));

    ivec3 OctSgn = NewOctBits - OldOctBits;

    if (Sgn.X < 0 && OctSgn.X > 0) return false;
    if (Sgn.Y < 0 && OctSgn.Y > 0) return false;
    if (Sgn.Z < 0 && OctSgn.Z > 0) return false;

    if (Sgn.X > 0 && OctSgn.X < 0) return false;
    if (Sgn.Y > 0 && OctSgn.Y < 0) return false;
    if (Sgn.Z > 0 && OctSgn.Z < 0) return false;

    return true;
}


uint GetNextOctant(in float tMax, in vec3 tValues, in uint CurrentOct)
{
    uint NextOct = CurrentOct;

    if (tMax >= tValues.X)
    {
        NextOct ^= 1;//|= CurrentOct ^ 1;
    }

    if (tMax >= tValues.Y)
    {
        NextOct ^= 2;//CurrentOct ^ 2;
    }

    if (tMax >= tValues.Z)
    {
        NextOct ^= 4;//|= CurrentOct ^ 4;
    }

    return NextOct;
}

uint GetOctant(in vec3 P, in vec3 ParentCentreP)
{
    uvec3 G = uvec3(GreaterThan(P, ParentCentreP));

    // TODO(Liam): Can use a DP here 
    return G.X + G.Y*2 + G.Z*4;
}


bool IsOctantOccupied(in uint Node, in uint Oct)
{
    return (Node & (1 << (8 + Oct))) != 0;
}

bool IsOctantLeaf(in uint Node, in uint Oct)
{
    return (Node & (1 << Oct)) != 0;
}

vec3 GetNodeCentreP(in uint Oct, in uint Scale, in vec3 ParentP)
{
    // TODO(Liam): We can actually use a bitwise AND op on uvec3s
    // so we don't have to work on scalars.

    float X = 1.0;
    float Y = 1.0;
    float Z = 1.0;

    // TODO(Liam): More speed here with step intrinsic?
    
    //  Use the bits of the input octant to compute the
    //  X, Y and Z vectors. A zero-bit corresponds to -1
    //  in some D direction, and a 1-bit corresponds to
    //  1.0 in D.
    if (0 == (Oct & 1)) X = -1.0;
    if (0 == (Oct & 2)) Y = -1.0;
    if (0 == (Oct & 4)) Z = -1.0;

    uint Radius = Scale >> 1;

    return ParentP + (vec3(X, Y, Z) * Radius);
}

vec3 Oct2Cr(in uint Oct)
{
    return vec3(uvec3(Oct));
}


uvec3 HDB(uvec3 A, uvec3 B)
{
    uvec3 DB = (A ^ B);

    // Find highest set bits
    uvec3 HighestSetBits = FindMSB(DB);

    return HighestSetBits;
}

struct st_frame
{
    uint Node;
    uint Depth;
    int Scale;
    float tMin;
    vec3 ParentCentre;
};

vec3 Raycast(in ray R)
{
    // Extant of the root cube
    int Scale = 1 << (ScaleExponentUniform);

    int BlkIndex = 0;
    
    vec3 RootMin = vec3(0);
    vec3 RootMax = vec3(Scale);
    vec3 Sgn = Sign(R.Dir);

    // Intersection of the ray with the root cube (i.e. entire tree)
    ray_intersection CurrentIntersection = ComputeRayBoxIntersection(R, RootMin, RootMax);

    int Step;

    // Check if the ray is within the octree at all
    if (CurrentIntersection.tMin <= CurrentIntersection.tMax && CurrentIntersection.tMax > 0)
    {
        // Ray enters octree --- begin processing

        // Initialise parent to root node
        uint ParentNode = SvoInputBuffer.Nodes[0];

        // Current position along the ray
        vec3 RayP = R.Origin + CurrentIntersection.tMin * R.Dir;

        vec3 ParentCentre = vec3(Scale >> 1);

        // Current octant the ray is in (confirmed good)
        uint CurrentOct = GetOctant(RayP, ParentCentre);
        
        // Initialise depth to 1
        uint CurrentDepth = 1;

        // Stack of previous voxels
        st_frame Stack[MAX_STEPS + 1] = { 0 };
        Scale >>= 1;
        Stack[CurrentDepth] = { ParentNode, CurrentDepth, Scale, CurrentIntersection.tMin, ParentCentre };

        // Begin stepping along the ray
        for (Step = 0; Step < MAX_STEPS; ++Step)
        {
            // Go down 1 level
            vec3 NodeCentre = GetNodeCentreP(CurrentOct, Scale, ParentCentre);
            vec3 NodeMin = NodeCentre - vec3(Scale >> 1);
            vec3 NodeMax = NodeCentre + vec3(Scale >> 1);

            CurrentIntersection = ComputeRayBoxIntersection(R, NodeMin, NodeMax);

            if (CurrentIntersection.tMin <= CurrentIntersection.tMax && CurrentIntersection.tMax > 0)
            {
                // Ray hit this voxel
                
                // Check if voxel occupied
                if (IsOctantOccupied(ParentNode, CurrentOct))
                {
                    // Octant is occupied, check if leaf
                    if (IsOctantLeaf(ParentNode, CurrentOct))
                    {
                        // Done - return leaf colour
                        float O = float(Step) / MAX_STEPS;
                        return O * vec3(0.4, 0, 0.3);
                    }
                    else
                    {
                        // Voxel has children --- execute push
                        ParentNode = GetNodeChild(ParentNode, CurrentOct, BlkIndex);
                        CurrentOct = GetOctant(RayP, NodeCentre);
                        ParentCentre = NodeCentre;
                        Scale >>= 1;
                        ++CurrentDepth;

                        Stack[CurrentDepth] = { ParentNode, CurrentDepth, Scale, CurrentIntersection.tMin, ParentCentre };

                        continue;
                    }
                }

                // Octant not occupied, need to handle advance/pop
                uint NextOct = GetNextOctant(CurrentIntersection.tMax, CurrentIntersection.tMaxV, CurrentOct);

                RayP = R.Origin + (CurrentIntersection.tMax + 1) * R.Dir;

                if (IsAdvanceValid(NextOct, CurrentOct, R.Dir))
                {
                    CurrentOct = NextOct;
                }
                else
                {
                    // Determined that NodeCentre is never < 0
                    uvec3 NodeCentreBits = uvec3(NodeCentre);
                    uvec3 RayPBits = uvec3(RayP);

                    // NOTE(Liam): It is **okay** to have negative values here
                    // because the HDB will end up being equal to ScaleExponentUniform.
                    uvec3 HighestDiffBits = HDB(NodeCentreBits, RayPBits);

                    uint M = uint(MaxComponent(HighestDiffBits));

                    M = 0;
                    if (HighestDiffBits.X > M && HighestDiffBits.X < ScaleExponentUniform) M = HighestDiffBits.X;
                    if (HighestDiffBits.Y > M && HighestDiffBits.Y < ScaleExponentUniform) M = HighestDiffBits.Y;
                    if (HighestDiffBits.Z > M && HighestDiffBits.Z < ScaleExponentUniform) M = HighestDiffBits.Z;

                    uint NextDepth = (ScaleExponentUniform - M);

                    if (NextDepth >= 0 && NextDepth <= MAX_STEPS)
                    {
                        CurrentDepth = NextDepth;
                        Scale = Stack[CurrentDepth].Scale;
                        ParentCentre = Stack[CurrentDepth].ParentCentre;
                        ParentNode = Stack[CurrentDepth].Node;

                        CurrentOct = GetOctant(RayP, ParentCentre);
                    }
                    else
                    {
                        return vec3(1, 1, 0);
                    }
                }
            }
            else
            {
                return vec3(0.5, 0.2, 0.6);
            }
        }
    }
    else
    {
        // Ray doesn't hit octree --- output background colour
        return vec3(0.12f);
    }

    return vec3(0, 0, 1);
}

bool Trace2(in ray R)
{
    vec3 Min = vec3(-4);
    vec3 Max = vec3(4);

    ray_intersection I = ComputeRayBoxIntersection(R, Min, Max);


    return I.tMin <= I.tMax;
}

int main()
{
    vec3 Right =  vec3(0.821647, -0.000000, 0.569997);
    vec3 Up = vec3(-0.095058, 0.985996, 0.137025);
    vec3 Forward = vec3(0.562015, 0.166769, -0.810140);
    vec3 Position = vec3(4.459143, 10.918401, 28.265924);

    mat3 View = {{
        { Right.X, Right.Y, Right.Z },
        { Up.X, Up.Y, Up.Z },
        { -Forward.X, -Forward.Y, -Forward.Z },
    }};

    // Ray XY coordinates of the screen pixels; goes from 0-512
    // in each dimension.
    for (int X = 0; X < 512; ++X)
    {
        for (int Y = 0; Y < 512; ++Y)
        {
            vec2 PixelCoords = { (float)Y, (float)X };
            vec3 ScreenOrigin = vec3(ViewPosUniform.X - 256, ViewPosUniform.Y - 256, ViewPosUniform.Z - 512);

            vec3 ScreenCoord = ScreenOrigin + vec3(PixelCoords.X, PixelCoords.Y, 0);

            vec3 RayP = Position;
            vec3 RayD = Normalize(ScreenCoord - Position);

            RayD = RayD * View;

            ray R = { RayP, RayD, Invert(RayD) };

            vec3 OutCr = Raycast(R);

            OutBuffer[X][Y] = OutCr;
        }
    }

    return 0;
}
